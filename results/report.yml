#
# Collect logs and build reports after the test execution
#
---

- hosts: compute
  vars:
    test_name: compute

  tasks:
  - name: Get info about test run
    shell: |
      echo "Test: {{ test_name }}" > info.txt
      echo -n "Start: " >> info.txt
      stat -c '%z' pgbench_init.log >> info.txt
      echo -n "Finish: " >> info.txt
      stat -c '%z' pgbench.log >> info.txt
    args:
      chdir: "/var/db/postgres/{{ test_name }}"
    become: yes

  - name: Download files
    fetch:
      src: /var/db/postgres/{{ test_name }}/{{ item }}
      dest: ./{{ item }}
      flat: yes
    become: yes
    loop:
    - pgbench.log
    - pgbench_init.log
    - postgresql.conf
    - info.txt

  - name: Download disk_test.log
    fetch:
      src: /var/db/postgres/disk_test.log
      dest: ./disk_test.log
      flat: yes
    become: yes

- hosts: safekeepers
  
  tasks:
  - name: Fetch disk_test.log
    fetch:
      src: "{{ main_dir }}/disk_test.log"
      dest: "./disk_test_{{ private_ip }}.log"
      flat: yes
    become: yes
